> 当前位置：【Java】09_Architecture_Distributed（分布式架构） -> 9.4_Zookeeper（分布式协调服务）



# 第一章 Zookeeper 下载安装和配置

## 0、Zookeeper 下载

- 官网下载：http://zookeeper.apache.org/releases.html
- 历史版本：https://archive.apache.org/dist/zookeeper/



## 1、Docker - Zookeeper 安装和配置

- Docker-Zookeeper 官网地址：https://hub.docker.com/_/zookeeper

  

### 1.1 拉取镜像

```shell
docker pull zookeeper:3.7.0
```



### 1.2 备份镜像

```shell
cd /docker_data/
docker save zookeeper:3.7.0 -o zookeeper:3.7.0.tar
```



### 1.3 导入镜像

```shell
docker load -i zookeeper:3.7.0.tar
```



### 1.4 Linux 创建并运行容器

#### （1）单机版

##### 步骤 1：创建文件夹

```shell
# 创建文件夹
mkdir -p /docker_data/zookeeper-2181/{data,logs,conf}
```



##### 步骤 2：创建 zoo.cfg

- 此文件夹下创建 /docker_data/zookeeper-2181/conf

```properties
# The number of milliseconds of each tick
tickTime=2000

# The number of ticks that the initial 
# synchronization phase can take
initLimit=10

# The number of ticks that can pass between 
# sending a request and getting an acknowledgement
syncLimit=5

# the directory where the snapshot is stored.
# do not use /tmp for storage, /tmp here is just 
# example sakes.
dataDir=/data
dataLogDir=/logs

# the port at which the clients will connect
clientPort=2181

# the maximum number of client connections.
# increase this if you need to handle more clients
#maxClientCnxns=60


# Be sure to read the maintenance section of the 
# administrator guide before turning on autopurge.
#
# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance

# The number of snapshots to retain in dataDir
#autopurge.snapRetainCount=3

# Purge task interval in hours
# Set to "0" to disable auto purge feature
#autopurge.purgeInterval=1

## Metrics Providers
#
# https://prometheus.io Metrics Exporter
#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
#metricsProvider.httpPort=7000
#metricsProvider.exportJvmInfo=true
```



##### 步骤 3：创建容器命令

```bash
cd /docker_data/zookeeper/

docker run -itd --name zookeeper --restart always -p 2181:2181 -v $(pwd)/conf/zoo.cfg:/conf/zoo.cfg  -v $(pwd)/data/:/data/ -v $(pwd)/logs:/logs zookeeper:3.7.0
```



#### （2）集群版 - 创建容器命令

##### 步骤1：创建 docker-compose.yml

```yml
version: '2.1'

services:
  zoo1:
    image: zookeeper
    restart: always
    hostname: zoo1
    volumes:
#      - /docker_data/zookeeper-2181/conf:/conf
      - /docker_data/zookeeper-2181/logs:/logs
      - /docker_data/zookeeper-2181/data:/data
    ports:
      - 2181:2181
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=0.0.0.0:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181

  zoo2:
    image: zookeeper
    restart: always
    hostname: zoo2
    volumes:
#      - /docker_data/zookeeper-2182/conf:/conf
      - /docker_data/zookeeper-2182/logs:/logs
      - /docker_data/zookeeper-2182/data:/data
    ports:
      - 2182:2181
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=0.0.0.0:2888:3888;2181 server.3=zoo3:2888:3888;2181

  zoo3:
    image: zookeeper
    restart: always
    hostname: zoo3
    volumes:
#      - /docker_data/zookeeper-2183/conf:/conf
      - /docker_data/zookeeper-2183/logs:/logs
      - /docker_data/zookeeper-2183/data:/data
    ports:
      - 2183:2181
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=0.0.0.0:2888:3888;2181
```



##### 步骤2：启动 docker-compose.yml

```bash
docker-compose up
```



##### 步骤3：查看集群状态

```bash
# 进入容器

# 切换目录
cd bin

# 查看 zk 状态
./zkServer.sh status
```



### 1.5 Mac 创建并运行容器

#### （1）单机版

##### 步骤 1：创建文件夹

```shell
# 创建文件夹
mkdir -p /Users/td/Documents/03_DevTools/docker_data/zookeeper-2181/{data,logs,conf}
```



##### 步骤 2：创建 zoo.cfg

- 此文件夹下创建 /Users/td/Documents/03_DevTools/docker_data/zookeeper-2181/conf

```properties
# The number of milliseconds of each tick
tickTime=2000

# The number of ticks that the initial 
# synchronization phase can take
initLimit=10

# The number of ticks that can pass between 
# sending a request and getting an acknowledgement
syncLimit=5

# the directory where the snapshot is stored.
# do not use /tmp for storage, /tmp here is just 
# example sakes.
dataDir=/data
dataLogDir=/logs

# the port at which the clients will connect
clientPort=2181

# the maximum number of client connections.
# increase this if you need to handle more clients
#maxClientCnxns=60


# Be sure to read the maintenance section of the 
# administrator guide before turning on autopurge.
#
# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance

# The number of snapshots to retain in dataDir
#autopurge.snapRetainCount=3

# Purge task interval in hours
# Set to "0" to disable auto purge feature
#autopurge.purgeInterval=1

## Metrics Providers
#
# https://prometheus.io Metrics Exporter
#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
#metricsProvider.httpPort=7000
#metricsProvider.exportJvmInfo=true
```



##### 步骤 3：创建容器命令

```bash
cd /Users/td/Documents/03_DevTools/docker_data/zookeeper/

docker run -itd --name zookeeper --restart always -p 2181:2181 -v $(pwd)/conf/zoo.cfg:/conf/zoo.cfg  -v $(pwd)/data/:/data/ -v $(pwd)/logs:/logs zookeeper:3.7.0
```



#### （2）集群版 - 创建容器命令

##### 步骤1：创建 docker-compose.yml

```yml
version: '2.1'

services:
  zoo1:
    image: zookeeper
    restart: always
    hostname: zoo1
    volumes:
#      - /docker_data/zookeeper-2181/conf:/conf
      - /Users/td/Documents/03_DevTools/docker_data/zookeeper-2281/logs:/logs
      - /Users/td/Documents/03_DevTools/docker_data/zookeeper-2281/data:/data
      - /Users/td/Documents/03_DevTools/docker_data/zookeeper-2281/datalog:/datalog
    ports:
      - 2181:2181
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zoo1:2888:3888 server.2=zoo2:2888:3888 server.3=zoo3:2888:3888

  zoo2:
    image: zookeeper
    restart: always
    hostname: zoo2
    volumes:
#      - /docker_data/zookeeper-2182/conf:/conf
      - /Users/td/Documents/03_DevTools/docker_data/zookeeper-2282/logs:/logs
      - /Users/td/Documents/03_DevTools/docker_data/zookeeper-2282/data:/data
      - /Users/td/Documents/03_DevTools/docker_data/zookeeper-2282/datalog:/datalog
    ports:
      - 2182:2181
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zoo1:2888:3888 server.2=zoo2:2888:3888 server.3=zoo3:2888:3888

  zoo3:
    image: zookeeper
    restart: always
    hostname: zoo3
    volumes:
#      - /docker_data/zookeeper-2183/conf:/conf
      - /Users/td/Documents/03_DevTools/docker_data/zookeeper-2283/logs:/logs
      - /Users/td/Documents/03_DevTools/docker_data/zookeeper-2283/data:/data
      - /Users/td/Documents/03_DevTools/docker_data/zookeeper-2283/datalog:/datalog
    ports:
      - 2183:2181
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zoo1:2888:3888 server.2=zoo2:2888:3888 server.3=zoo3:2888:3888
```



##### 步骤2：启动 docker-compose.yml

```bash
docker-compose up
```



##### 步骤3：查看集群状态

```bash
# 进入容器

# 切换目录
cd bin

# 查看 zk 状态
./zkServer.sh status
```



## 2、Linux系统 - Zookeeper 安装和配置

- TODO



## 3、Win系统 - Zookeeper 安装和配置

- TODO



## 4、Mac系统 - Zookeeper 安装和配置

- 

```properties
# The number of milliseconds of each tick
tickTime=2000

# The number of ticks that the initial 
# synchronization phase can take
initLimit=10

# The number of ticks that can pass between 
# sending a request and getting an acknowledgement
syncLimit=5

# the directory where the snapshot is stored.
# do not use /tmp for storage, /tmp here is just 
# example sakes.
dataDir=/data
dataLogDir=/logs

# the port at which the clients will connect
clientPort=2181

# the maximum number of client connections.
# increase this if you need to handle more clients
#maxClientCnxns=60


# Be sure to read the maintenance section of the 
# administrator guide before turning on autopurge.
#
# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance

# The number of snapshots to retain in dataDir
#autopurge.snapRetainCount=3

# Purge task interval in hours
# Set to "0" to disable auto purge feature
#autopurge.purgeInterval=1

## Metrics Providers
#
# https://prometheus.io Metrics Exporter
#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
#metricsProvider.httpPort=7000
#metricsProvider.exportJvmInfo=true
```







# 第二章 Zookeeper 简介



# 第三章 Zookeeper 操作命令

## 1、启动/查看/重启/连接

```bash
# 启动ZK服务
./zkServer.sh start

# 查看ZK服务状态
./zkServer.sh status

# 停止ZK服务
./zkServer.sh stop

# 重启ZK服务
./zkServer.sh restart

# 连接客户端服务器
./zkCli.sh -server 127.0.0.1:2181

# 退出客户端服务器
quit
```



## 2、创建节点

```bash
# 创建持久节点
create /china

# japan必须提前创建好，否则报错 “节点不存在”
create /japan/Tokyo "hot" 

# 创建临时节点（退出客户端就销毁）
create -e /uk 

# 创建顺序节点（带序号）
# 如果原来没有序号节点，序号从0开始递增
# 如果原节点下已有2个节点，则再排序时从2开始，以此类推
create -s /ru/city 
```



## 3、读取节点

```bash
# 获取节点值
get /japan/Tokyo

# 查看当前znode中所包含的内容
ls /

# 查看当前节点详细数据
# zookeeper老版本使用 
ls2 /

# 新命令
ls -s /

# cZxid：Create ZXID，表示节点被创建时的事务ID
- 每次修改ZooKeeper状态都会收到一个zxid形式的时间发，也就是ZooKeeper事务ID。
- 事务ID是ZooKeeper中所有修改总的次序
- 每个修改都有唯一的zxid，如时zxid1小于zxid2，那么zxid1在zxid2之前发生。

# ctime：Create Time，表示节点创建时间（从1970年开始）

# mZxid：Modified ZXID，表示节点最后⼀次被修改时的事务ID

# mtime：Modified Time，表示节点最后⼀次被修改的时间（从1970年开始）

# pZxid：表示该节点的⼦节点列表最后⼀次被修改时的事务 ID。只有⼦节点列表变更才会更新 pZxid，⼦节点内容变更不会更新

# cversion 表示⼦节点的版本号，子节点修改次数

# dataVersion 表示内容版本号

# aclVersion 标识acl版本，权限版本号

# ephemeralOwner 表示创建该临时节点时的会话 sessionID，如果是持久性节点（不是临时节点）那么值为 0

# dataLength 表示数据⻓度。

# numChildren 表示直系⼦节点数。
```



## 3、更新节点

```bash
# 语法
set path data [version]

# 修改节点数据 
set /testnode/node1 aaa  
```



## 4、删除节点

```bash
# 语法
delete path [version]

# 删除节点
delete /usa/NewYork

# 递归删除节点 (非空节点，节点下有子节点)
# 不仅删除/ru，而且/ru下的所有子节点也随之删除
deleteall /ru
```



## 5、监听节点

```bash
# 监听节点的值变化 或 子节点变化(路径变化) addWatch /usa

# 在server3主机上注册监听/usa节点的数据变化
addWatch /usa

# 在Server1主机上修改/usa的数据
set /usa "telangpu”

# Server3会立刻响应
WatchedEvent state:SyncConnected type:NodeDataChanged path:/usa

# 如果在Server1的/usa下面创建子节点NewYork
create /usa/NewYork

# Server3会立刻响应
WatchedEvent state:SyncConnected type:NodeCreatedpath:/usa/NewYork
```



# 第四章 Zookeeper 的API使⽤

