> 当前位置：【01】编程必备 -> 计算机网络 -> 02-网络层协议



# 第一章 IP 协议

## 1、什么是 IP 协议？

- IP 协议（Internet Protocol）是一个处于垄断地位的网络层协议
- 在网络层，IP 协议几乎一统天下



## 2、IP 协议分类

- IP 协议目前主要有两个版本 IPv4 和 IPv6

![image-20210818083900850](image/image-20210818083900850.png)



## 3、IP 协议不保证可靠性

- IP 协议并不负责数据的可靠性，自身不能保证可靠性

```
- 传输数据时，数据被切分成一个个数据封包。
- IP 协议上层的传输层协议会对数据进行一次拆分，IP 协议还会进一步进行拆分。
- 进行两次拆分是为了适配底层的设备。
```

- IP 协议可能会遇到的几个问题（ IP 协议并不会去处理这些问题，因为网络层只专注解决网络层的问题， 而且不同特性的应用在不同场景下需要解决的问题不一样）

```
- 封包损坏（数据传输过程中被损坏）
- 丢包（数据发送过程中丢失）
- 重发（数据被重发，比如中间设备通过 2 个路径传递数据）
- 乱序（到达目的地时数据和发送数据不一致）
```

- 数据在网络中交换（封包交换算法），并不需要预先建立一个连接，而是任由数据在网络中传输，每个节点通过路由算法帮助数据封包选择下一个目的地。



# 第二章 IPv4 协议

## 1、什么是 IPv4 协议

- IPv4 就是 IP 协议的第 4 个版本，是目前互联网的主要网络层协议。
- IPv4 为传输层提供 Host-To-Host 的能力
- IPv4 需要底层数据链路层的支持。



## 2、IP 协议的工作原理

- IP 协议接收 IP 协议上方的 Host-To-Host 协议传来的数据，然后进行拆分，这个能力叫作分片（Fragmentation）
- 然后 IP 协议为每个片段（Fragment）增加一个 IP 头（Header），组成一个IP 封包（Datagram）
- 之后，IP 协议调用底层的局域网（数据链路层）传送数据
- 最后 IP 协议通过寻址和路由能力最终把封包送达目的地



### 2.1 分片（Fragmentation）

- 分片就是把数据切分成片。 
- IP 协议通过它下层的局域网（链路层）协议传输数据，因此需要适配底层传输网络的传输能力。数据太大通常就不适合底层网络传输，这就需要把大的数据切片。 
- 当然也可能选择不切片，IP 协议提供了一个能力就是把封包标记为不切片，当底层网络看到不切片的封包，又没有能力传输的时候，就会丢弃这个封包。
- 你要注意，在网络环境中往往存在多条路径，一条路径断了，说不定其他路径可以连通。



### 2.2 增加协议头（IP Header）

- 切片完成之后，IP 协议会为每个切片（数据封包 Datagram）增加一个协议头
- IPv4 的地址是 4 组 8 位的数字，总共是 32 位

![image-20210818084810172](image/image-20210818084810172.png)

#### （1）IHL（Internet Header Length）

- 用来描述 IP 协议头的大小

- IP 协议头的大小是可变的
- IHL 只有 4 位，最大值 1111 = 15。最大是 15 个双字（15*4 字节 = 60 字节）



#### （2）Type Of Service 

- 服务的类型（是为了响应不同的用户诉求，用来选择延迟、吞吐量和丢包率之间的关系）

- 延迟（latency）

```
- 延迟指的是 1 bit 的数据从网络的一个终端传送到另一个终端需要的时间
- 这个时间包括在发送端准备发送的时间、排队发送的时间、发送数据的时间、数据传输的时间等
```

- 吞吐量（Throughput）

```
- 吞吐量指单位时间内可以传输的平均数据量
- 比如用 bit/s 作为单位，就是 bps

- 吞吐量和延迟没有联系
- 比如延迟很高的网络，有可能吞吐量很高。可以类比成水管很大流速很慢，对比水管很细流速很快，这两种情况，最终流量可以是相等的。
```

- 丢包率（Packet loss）

```
- 丢包率指发送出去的封包没有到达目的地的比例
- 在最大流速确定的网络中，丢包率会直接影响吞吐量
```



- 这三个条件，通常不能同时满足。如果同时追求延迟、吞吐量、丢包率，那么对网络设备的要求就会非常高，说白了就会非常贵。因此 IP 协议头中的 Type of Service 字段里，有以下 4 种主要的类型可以选择
  - 低延迟
  - 高吞吐量
  - 低丢包率
  - 低成本



#### （3）Total Length

- 定义报文（封包 Datagram）的长度



#### （4）Identification

- 报文的 ID

- 发送方分配，代表顺序



#### （5）Fragment offset 

- 描述要不要分包（拆分），以及如何拆分



#### （6）Time To Live

- 描述封包存活的时间
- 因此每个 IP 封包发送出去后，就开始销毁倒计时。
- 如果倒计时为 0，就会销毁。
- 比如中间的路由器看到一个 TTL 为 0 的封包，就直接丢弃。



#### （7）Protocol 

- 描述上层的协议，比如 TCP = 6，UDP = 17



#### （8）Checksum 

- 用来检验封包的正确性
- 如果 Checksum 对不上，就需要选择丢弃这个封包



#### （9）Source address

- 原地址



#### （10）Destination address

- 目标地址

  

#### （11）Options

- 代表可选项



### 2.3 寻址（Addressing）

- 地址想要表达的是一个东西在哪里
- 寻址要做的就是：给一个地址，然后找到这个东西
- IPv4 协议的寻址过程是逐级寻址



#### （1）IPv4 地址

- Pv4 地址是 4 个 8 位（Octet）排列而成，总共可以编址 43 亿个地址

```
- 比如 103.16.3.1 就是一个合法的 Ipv4 地址
- 4 组数字用.分开，是为了让人可读，实际上在内存和传输过程中，就是直接用 32 位

  103        16         3        1
01100111  00010000  00000011 00010001
```



#### （2）寻址过程

- 寻址就是如何根据 IP 地址找到设备
- IP 协议的寻址过程需要逐级找到网络，最后定位设备
- 因为 IPv4 的世界中，网络是一个树状模型。顶层有多个平行的网络，每个网络有自己的网络号。然后顶层网络下方又有多个子网，子网下方还有子网，最后才是设备。

![image-20210818090723712](image/image-20210818090723712.png)



##### 步骤 1：找到顶层网络

- 比如 103.16.3.1 最顶层的网络号可以和 255.0.0.0（子网掩码）做位与运算得到

```bash
# 103.0.0.0 就是 103.16.3.1 所在的顶层网络
103.16.3.1 & 255.0.0.0 = 103.0.0.0 
```

- 255.0.0.0.称作子网掩码

```
- 子网掩码的作用：根据 IP 地址找到对应子网
- 子网掩码是很多个1接着很多个0，和 IP 地址一起使用
```



##### 步骤 2：找到下一层网络

- 接下来要找到下一级网络，就需要用 IP 地址和下一级的子网掩码做位与运算。

```bash
# 103.16.0.0就是下一级的网络号
103.16.3.1 & 255.255.0.0 = 103.16.0.0
```



##### 步骤 3：找到再下一级网络

- 接下来使用 255.255.255.0 子网掩码找到下一级网络是103.16.3.0



##### 步骤 4：定位设备

- 设备就在子网103.16.3.0中，最终找到的设备号是1

- 当然子网掩码也不一定都是255，比如这个子网掩码 255.240.0.0 也是可以的



### 2.4 路由（Routing）

- 在寻址过程中，数据总是存于某个局域网中。如果目的地在局域网中，就可以直接定位到设备了。如果目的地不在局域网中，这个时候，就需再去往其他网络。

- 由于网络和网络间是网关在连接，因此如果目的地 IP 不在局域网中，就需要为 IP 封包选择通往下一个网络的路径，其实就是选择其中一个网关。

![image-20210818094347653](image/image-20210818094347653.png)



- 假如，我们要为 IP 地址 14.215.177.38 寻址
- 当前路由器所在的网络的编号是16.0.0.0
- 那么我们就需要知道去往 14.0.0.0 网络的 Gateway IP 地址



- 如果你在当前网络中用 route 查看路由表，可能可以看到一条下面这样的记录

```bash
Destination：14.0.0.0
Gateway：16.12.1.100
Mask：255.0.0.0
Iface：16.12.1.1
```

- 这条记录就说明如果你要去往 14.0.0.0 网络，IP 地址 14.215.177.38 先要和 255.0.0.0 进行位运算，然后再查表，看到 14.0.0.0，得知去往 Gateway 的网卡（IFace）是 16.12.1.1。

- 当封包去向下一个节点后，会进入新的路由节点，然后会继续上述路由过程，直到最终定位到设备



## 3、总结

- 首先 IP 协议会进行分片，将上游数据拆成一个个的封包（Datagram），然后为封包增加 IP 头部。封包发送出去后，就开始了寻址过程。寻址就是找到 IP 地址对应的设备。在局域网内，如果找不到设备，就需要路由。路由就是找到数据应该往哪里发送。最后通过层层路由定位到具体的设备。



## 面试题

- 路由和寻址的区别是什么？

```
【解析】
- 寻址（Addressing）就是通过地址找设备
- 和现实生活中的寻址是一样的，比如根据地址找到一个公寓。
- 在 IPv4 协议中，寻址找到的是一个设备所在的位置。

- 路由（Routing）本质是路径的选择
- 就好像知道地址，但是到了每个十字路口，还需要选择具体的路径。
- 所以，要做路由，就必须能够理解地址，也就是需要借助寻址的能力。要通过寻址找到最终的设备，又要借助路由在每个节点选择数据传输的线路

- 因此，路由和寻址，是相辅相成的关系。
```



# 第三章 IPv6 协议